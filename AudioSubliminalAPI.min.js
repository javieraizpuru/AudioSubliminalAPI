class AudioDevice{constructor(t){let e=d3.select(document.createElement("style"));return e.node().type="text/css",e.node().innerHTML=".hideScrollbar{scrollbar-width: none; -ms-overflow-style: none;} .hideScrollbar::-webkit-scrollbar { display: none }",d3.select("head").append(()=>e.node()),this._container=d3.select(t).style("overflow-x","scroll").style("overflow-y","hidden").classed("hideScrollbar",!0),this._multiplier=1,this._width=this._container.node().offsetWidth,this._height=this._container.node().offsetHeight,this._background="white",this._color="rgb(153, 153, 153)",this._playheadColor="black",this._barWidth=1,this._barGap=1,this._type="waveform",this._mainWaveform=d3.select(document.createElement("div")).style("height","100%").style("width","100%").style("position","absolute").style("overflow-x","hidden").style("overflow-y","hidden"),this._container.append(()=>this._mainWaveform.node()),this}_prepareAudio(){this._ctx=new(window.AudioContext||window.webkitAudioContext),this._output=this._ctx.createGain(),this._output.connect(this._ctx.destination)}_isReady(t){this._ready||(this._prepareAudio(),this._ready=!0),t()}_dataFilter(t,e,i=!1){for(var a=Math.round(t.length/e),s=[],r=a,h=0;h<e;h++){for(var n=0,o=0,l=0;l<r;l++){var d=t[h*a+l];d>0?n+=d:o+=d}i?(s.push(2*n/r),s.push(2*o/r)):s.push([o/r,n/r])}return s}setVolume(t){this._isReady(()=>{this._output.gain.linearRampToValueAtTime(t,.2)})}height(t){return this._multiplier=t,this}fill(t){return this._color=t,this}background(t){return this._background=t,this._container.style("background",t),this}playhead(t){return this._playheadcolor=t,this}barWidth(t){return this._barWidth=t,this}barGap(t){return this._gap=t,this}type(t){return"bar"==t?(this._type="bar",this._gap=1):(this._type="waveform",this._gap=0),this}meter(t,e,i){let a=d3.select(t);this._meter=a.append("canvas").attr("height",a.style("height")).attr("width",a.style("width")).attr("position","absolute");let s=this._meter.node().getContext("2d");const r=parseInt(this._meter.attr("width")),h=parseInt(this._meter.attr("height"));return s.fillStyle=i,s.rect(0,0,r,h),s.fill(),this._meterFill=e,this._meterEnabled=!0,this}}class AudioPlayer extends AudioDevice{static create(t){return new AudioPlayer(t)}constructor(t){super(t),this._sleep=!1,this._sleepStarted=!1,this._secondaryColor="black",this._audioElement=d3.select(document.createElement("audio")),this._altAudioElement=d3.select(document.createElement("audio")),this._mainWaveform.on("click",()=>{this._seekPosition(d3.mouse(this._mainWaveform.node())[0])}),window.addEventListener("resize",()=>{this._reloadWaveform()}),this._secondaryWaveform=d3.select(document.createElement("div")).style("height","100%").style("width","0px").style("position","absolute").style("border-right","1px solid #111").style("z-index","3").style("overflow","hidden"),this._secondaryWaveform.on("click",()=>{this._seekPosition(d3.mouse(this._secondaryWaveform.node())[0])}),this._container.append(()=>this._secondaryWaveform.node()),this._container.append(()=>this._audioElement.node()),this._container.append(()=>this._altAudioElement.node()),this.alt.load=(t=>{this.alt._isPlaying&&this.alt.stop(),this._altAudioElement.node().src=t,this._altAudioElement.node().loop=!0}),this.alt.play=(()=>{this._altAudioElement.node().play(),this.alt._isPlaying=!0}),this.alt.playStop=(()=>{this.alt._isPlaying?this.alt.stop():this.alt.play()}),this.alt.stop=(()=>{this._altAudioElement.node().pause(),this.alt._isPlaying=!1}),this.alt.setVolume=(t=>{this._isReady(()=>{this._altOutput.gain.linearRampToValueAtTime(t,.2)})}),this.alt.isPlaying=(()=>this.alt._isPlaying)}_prepareAudio(){if(super._prepareAudio(),this._isPlaying=!1,this.alt._isPlaying=!1,this._source=this._ctx.createMediaElementSource(this._audioElement.node()),this._altSource=this._ctx.createMediaElementSource(this._altAudioElement.node()),this._splitter=this._ctx.createChannelSplitter(2),this._source.connect(this._splitter),this._altOutput=this._ctx.createGain(),this._altSource.connect(this._altOutput),this._altOutput.connect(this._ctx.destination),this._meterEnabled){this._meterAnalyser=this._ctx.createAnalyser(),this._output.connect(this._meterAnalyser);let t=this._meterAnalyser.frequencyBinCount;this._meterAnalyser.fftsize=2048,this._meterAnalyser.smoothingTimeConstant=1,this._analyserData=new Float32Array(t),this._meterAnalyser.getFloatTimeDomainData(this._analyserData)}this._chooseSource()}_getPixelPosition(t){return this._duration=this._audioElement.node().duration,t*this._duration/this._width}_seekPosition(t){let e=0==t?0:this._getPixelPosition(t);this._audioElement.node().currentTime=e,this._secondaryWaveform.style("width",t+"px")}_createWaveform(t){let e="bar"==this._type?this._barWidth:1,i="bar"==this._type?this._gap:0,a=e+i,s=this._height/2,r=s*this._multiplier;const h=(t,i)=>{let h=i?this._secondaryColor:this._color;(i=>{null==this._context&&(this._context=i.node().getContext("2d"),this._dataCanvas=d3.select(document.createElement("canvas")),this._dataCanvas.attr("height",i.attr("height")));let n=d3.select(document.createElement("custom"));n.selectAll("custom.rect").data(t).enter().append("custom").classed("rect",!0).attr("x",(t,e)=>e*a).attr("y",function(t,e){return s/2-r*t[1]}).attr("width",e).attr("height",function(t){return r*(t[1]-t[0])}).attr("fillStyle",h);let o=i.node().getContext("2d");o.fillStyle=this._background,o.fillRect(0,0,o.canvas.width,o.canvas.height),n.selectAll("custom.rect").each(function(t,e,i){let a=d3.select(this);o.beginPath(),o.fillStyle=a.attr("fillStyle"),o.rect(a.attr("x"),a.attr("y"),a.attr("width"),a.attr("height")),o.fill(),o.closePath()})})((i?this._secondaryWaveform:this._mainWaveform).append("canvas").attr("width",this._width).attr("height",s))};let n=this._dataFilter(t[0],this._width/(e+i)),o=this._dataFilter(t[1],this._width/(e+i));h(n,!1),h(o,!1),h(n,!0),h(o,!0)}_reloadWaveform(){this._mainWaveform.selectAll("canvas").remove(),this._secondaryWaveform.selectAll("canvas").remove(),this._height=this._container.node().offsetHeight,this._width=this._container.node().offsetWidth,void 0!==this._waveform&&this._createWaveform(this._waveform)}_stopPlayhead(){this._audioElement.node().pause(),this._isPlaying=!1}_startPlayhead(){this._audioElement.node().play(),this._isPlaying=!0;const t=()=>{if(this._duration=this._audioElement.node().duration,this._playhead=requestAnimationFrame(t),this._isPlaying){let t=this._audioElement.node().currentTime*this._width/this._duration;this._secondaryWaveform.style("width",t+"px")}if(this._meterEnabled){let t,e;if(this._isPlaying){this._meterAnalyser.getFloatTimeDomainData(this._analyserData);let i=0;this._analyserData.forEach((t,e)=>{i+=Math.sqrt(Math.abs(t))});let a=i/this._analyserData.length;t=((e=a>this._lastMean?10*Math.log10(a):10*Math.log10(this._lastMean)-1)+30)/30,this._lastMean=a}else t=((e=10*Math.log10(this._lastMean)-1)+30)/30,this._lastMean=Math.pow(10,e/10),e<-60&&cancelAnimationFrame(this._playhead);let i=this._meter.node().getContext("2d");const a=parseInt(this._meter.attr("width")),s=parseInt(this._meter.attr("height"));i.fillStyle=this._background,i.fillRect(0,0,a,s),i.fillStyle=this._meterFill,i.fillRect(0,s*(1-t),a,s*t)}};t()}_chooseSource(t){this._splitter.disconnect(),t?this._splitter.connect(this._output,1):this._splitter.connect(this._output,0)}load(t,e){this._seekPosition(0),this.stop(),this._audioElement.attr("src",t),this._audioElement.node().loop=!0,this._mainWaveform.selectAll("canvas").remove(),this._secondaryWaveform.selectAll("canvas").remove(),this._waveform=e,this._createWaveform(e)}alt(){}play(){this._isReady(this._startPlayhead.bind(this))}playStop(){this._isReady(()=>{this._isPlaying?this.stop():this.play()})}stop(){this._stopPlayhead()}fill(t,e){return super.fill(t),null!=e&&(this._secondaryColor=e),this}playhead(t){return this._secondaryWaveform.style("border-right","1px solid "+this._playheadcolor),this}setSubliminal(t){this._isReady(()=>{this._chooseSource(t)})}getOutputNode(){return null==this._output&&this._isReady(),this._output}getContext(){return null==this._ctx&&this._isReady(),this._ctx}isPlaying(){return this._isPlaying}}class AudioRecorder extends AudioDevice{static create(t){return new AudioRecorder(t)}constructor(t){return super(t),this._mainWaveform.style("direction","rtl"),this}_createWaveform(t){let e="bar"==this._type?this._barWidth:1,i="bar"==this._type?this._gap:0,a=e+i,s=this._height,r=s*this._multiplier;((i,h)=>{let n=this._color,o=this._mainWaveform;let l=t.length*a;null==this._canvas?this._canvas=o.append("canvas").attr("width",l).attr("height",this._height).style("border-right","1px solid "+this._playheadcolor):this._canvas.attr("width",l),(t=>{null==this._context&&(this._context=t.node().getContext("2d")),null==this._dataContainer&&(this._dataContainer=document.createElement("custom"),this._dataCanvas=d3.select(document.createElement("canvas")),this._dataCanvas.attr("height",t.attr("height")));let h=d3.select(this._dataContainer).selectAll("custom.rect").data(i);const o=()=>this._context,l=()=>this._dataCanvas.node();h.enter().append("custom").classed("rect",!0).attr("x",(t,e)=>e*a).attr("y",function(t,e){return s/2-r*t[1]}).attr("width",e).attr("height",function(t){return r*(t[1]-t[0])}).attr("fillStyle",n).call(e=>{let i=o();return i.fillStyle=this._background,i.fillRect(0,0,i.canvas.width,i.canvas.height),e.each(function(t,e){let a=d3.select(this);i.drawImage(l(),0,0),i.beginPath(),i.fillStyle=a.attr("fillStyle"),i.rect(a.attr("x"),a.attr("y"),a.attr("width"),a.attr("height")),i.fill(),i.closePath()}),this._dataCanvas.attr("width",t.attr("width")),l().getContext("2d").drawImage(t.node(),0,0),e})})(this._canvas)})(t)}_normalizeData(t){let e=t;const i=(t=>{let e=Number.MIN_VALUE;return t.forEach((t,i)=>{e=t>e?t:e}),e})(e);return e.forEach((t,a)=>{0!=t&&(e[a]=t/i)}),e}_getWaveform(t){let e=[];const i=this._dataFilter(this._normalizeData(t.getChannelData(0)),1920,!0),a=this._dataFilter(this._normalizeData(t.getChannelData(1)),1920,!0);return e.push(i),e.push(a),JSON.stringify(e)}_stopRecording(){let t=!0;return null!=this._mediaRecorder&&this._mediaRecorder.isRecording()&&(this._mainWaveform.style("overflow-x","scroll").classed("hideScrollbar",!0),this._mediaRecorder.finishRecording(),this._stream.getTracks().forEach(t=>{t.stop()}),this._data=[],this._ctx.suspend(),this._dataCanvas.remove(),this._dataContainer=null,this._dataCanvas=null,t=!1),t}_startRecording(){this._isReady(()=>{this._ctx.resume(),navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{this._recordingTime=0,this._currentTime=new Date,Tone.context=this._ctx,this._mainWaveform.style("overflow-x","hidden"),this._stream=t;const e=this._ctx.createMediaStreamSource(t);this.merger=this._ctx.createChannelMerger(2);let i=this._ctx.createAnalyser(),a=this._ctx.createGain(),s=new Tone.Tremolo(17e3,1),r=new Tone.Filter(16e3,"highpass",-48);s.spread=0,Tone.connect(e,a),Tone.connect(a,s),s.connect(r),r.connect(this.merger,0,1),e.connect(this.merger,0,0),e.connect(i),this._mediaRecorder=new WebAudioRecorder(this.merger,{workerDir:this._libraryPath,encoding:"wav",options:{encodeAfterRecord:!0}}),s.start(),this._mediaRecorder.startRecording(),i.fftSize=2048;let h=i.frequencyBinCount,n=new Float32Array(h);i.getFloatTimeDomainData(n),this._data=[];const o=()=>{if(this._drawVisual=requestAnimationFrame(o),i.getFloatTimeDomainData(n),this._mediaRecorder.isRecording()){let t=new Date;this._recordingTime=t-this._currentTime;let e=this._dataFilter(n,~~(n.length/1e3));for(let t of e)this._data.push(t);this._createWaveform(this._data)}l()},l=()=>{let t,e;if(this._mediaRecorder.isRecording()){let i=0;n.forEach((t,e)=>{i+=Math.sqrt(Math.abs(t))});let a=i/n.length;t=((e=a>this._lastMean?10*Math.log10(a):10*Math.log10(this._lastMean)-1)+30)/30,this._lastMean=a}else t=((e=10*Math.log10(this._lastMean)-1)+30)/30,this._lastMean=Math.pow(10,e/10),e<-60&&cancelAnimationFrame(this._drawVisual);let i=this._meter.node().getContext("2d");const a=parseInt(this._meter.attr("width")),s=parseInt(this._meter.attr("height"));i.fillStyle=this._background,i.fillRect(0,0,a,s),i.fillStyle=this._meterFill,i.fillRect(0,s*(1-t),a,s*t)};this._mediaRecorder.onComplete=((t,e)=>{const i=t=>{this._ctx.decodeAudioData(t).then(t=>{this.getRecordingData(e,this._getWaveform(t))})};if("function"==typeof e.arrayBuffer)e.arrayBuffer().then(t=>i(t));else{const t=new FileReader;t.onload=(t=>{const e=t.target.result;i(e)}),t.readAsArrayBuffer(e)}}),o()})})}stop(){this._stopRecording}record(){this._stopRecording()&&this._startRecording()}getRecordingData(){}getRecordingTime(){return null==this._recordingTime&&(this._recordingTime=0),this._recordingTime}libraryPath(t){return this._libraryPath=t,this}}export{AudioPlayer,AudioRecorder};
