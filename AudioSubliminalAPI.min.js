class AudioPlayer{static create(t){return new AudioPlayer(t)}constructor(t){this._sleep=!1,this._sleepStarted=!1;const e=()=>{if(this._ctx=new(window.AudioContext||window.webkitAudioContext),this._isPlaying=!1,this.alt._isPlaying=!1,this._source=this._ctx.createMediaElementSource(this._audioElement.node()),this._altSource=this._ctx.createMediaElementSource(this._altAudioElement.node()),this._splitter=this._ctx.createChannelSplitter(2),this._source.connect(this._splitter),this._altOutput=this._ctx.createGain(),this._altSource.connect(this._altOutput),this._altOutput.connect(this._ctx.destination),this._output=this._ctx.createGain(),this._output.connect(this._ctx.destination),this._meterEnabled){this._meterAnalyser=this._ctx.createAnalyser(),this._output.connect(this._meterAnalyser);let t=this._meterAnalyser.frequencyBinCount;this._meterAnalyser.fftsize=2048,this._meterAnalyser.smoothingTimeConstant=1,this._analyserData=new Float32Array(t),this._meterAnalyser.getFloatTimeDomainData(this._analyserData)}d()},i=t=>(this._duration=this._audioElement.node().duration,t*this._duration/this._width),s=t=>{let e=0==t?0:i(t);this._audioElement.node().currentTime=e,this._secondaryWaveform.style("width",t+"px")},a=(t,e,i=!1)=>{for(var s=Math.round(t.length/e),a=[],h=s,n=0;n<e;n++){for(var r=0,l=0,o=0;o<h;o++){var d=t[n*s+o];d>0?r+=d:l+=d}i?(a.push(2*r/h),a.push(2*l/h)):a.push([l/h,r/h])}return a},h=t=>{let e="bar"==this._type?this._barWidth:1,i="bar"==this._type?this._gap:0,s=e+i,h=this._height/2,n=h*this._multiplier;const r=(t,i)=>{let a=i?this._secondaryColor:this._color;(i=>{null==this._context&&(this._context=i.node().getContext("2d"),this._dataCanvas=d3.select(document.createElement("canvas")),this._dataCanvas.attr("height",i.attr("height")));let r=d3.select(document.createElement("custom"));r.selectAll("custom.rect").data(t).enter().append("custom").classed("rect",!0).attr("x",(t,e)=>e*s).attr("y",function(t,e){return h/2-n*t[1]}).attr("width",e).attr("height",function(t){return n*(t[1]-t[0])}).attr("fillStyle",a);let l=i.node().getContext("2d");l.fillStyle=this._background,l.fillRect(0,0,l.canvas.width,l.canvas.height),r.selectAll("custom.rect").each(function(t,e,i){let s=d3.select(this);l.beginPath(),l.fillStyle=s.attr("fillStyle"),l.rect(s.attr("x"),s.attr("y"),s.attr("width"),s.attr("height")),l.fill(),l.closePath()})})((i?this._secondaryWaveform:this._mainWaveform).append("canvas").attr("width",this._width).attr("height",h))};let l=t,o=a(l[0],this._width/(e+i)),d=a(l[1],this._width/(e+i));r(o,!1),r(d,!1),r(o,!0),r(d,!0)},n=()=>{this._mainWaveform.selectAll("canvas").remove(),this._secondaryWaveform.selectAll("canvas").remove(),this._height=this._container.node().offsetHeight,this._width=this._container.node().offsetWidth,h(this._waveform)},r=()=>{this._audioElement.node().pause(),this._isPlaying=!1},l=()=>{this._audioElement.node().play(),this._isPlaying=!0;const t=()=>{if(this._duration=this._audioElement.node().duration,this._playhead=requestAnimationFrame(t),this._isPlaying){let t=this._audioElement.node().currentTime*this._width/this._duration;this._secondaryWaveform.style("width",t+"px")}if(this._meterEnabled){let t,e;if(this._isPlaying){this._meterAnalyser.getFloatTimeDomainData(this._analyserData);let i=0;this._analyserData.forEach((t,e)=>{i+=Math.sqrt(Math.abs(t))});let s=i/this._analyserData.length;t=((e=s>this._lastMean?10*Math.log10(s):10*Math.log10(this._lastMean)-1)+30)/30,this._lastMean=s}else t=((e=10*Math.log10(this._lastMean)-1)+30)/30,this._lastMean=Math.pow(10,e/10),e<-60&&cancelAnimationFrame(this._playhead);let i=this._meter.node().getContext("2d");const s=parseInt(this._meter.attr("width")),a=parseInt(this._meter.attr("height"));i.fillStyle=this._background,i.fillRect(0,0,s,a),i.fillStyle=this._meterFill,i.fillRect(0,a*(1-t),s,a*t)}};t()},o=t=>{this._ready||(e(),this._ready=!0),t()},d=t=>{this._splitter.disconnect(),t?this._splitter.connect(this._output,1):this._splitter.connect(this._output,0)};return this.alt=(()=>{}),this.load=((t,e)=>{s(0),this.stop(),this._audioElement.attr("src",t),this._audioElement.node().loop=!0,this._mainWaveform.selectAll("canvas").remove(),this._secondaryWaveform.selectAll("canvas").remove(),this._waveform=e,window.addEventListener("resize",n),h(e)}),this.alt.load=(t=>{this.alt._isPlaying&&this.alt.stop(),this._altAudioElement.node().src=t,this._altAudioElement.node().loop=!0}),this.play=(()=>{o(l)}),this.alt.play=(()=>{this._altAudioElement.node().play(),this.alt._isPlaying=!0}),this.playStop=(()=>{o(()=>{this._isPlaying?this.stop():this.play()})}),this.alt.playStop=(()=>{this.alt._isPlaying?this.alt.stop():this.alt.play()}),this.stop=(()=>{r()}),this.alt.stop=(()=>{this._altAudioElement.node().pause(),this.alt._isPlaying=!1}),this.setVolume=(t=>{o(()=>{this._output.gain.linearRampToValueAtTime(t,.2)})}),this.alt.setVolume=(t=>{o(()=>{this._altOutput.gain.linearRampToValueAtTime(t,.2)})}),this.height=(t=>(this._multiplier=t,this)),this.fill=((t,e)=>(this._color=t,null!=e&&(this._secondaryColor=e),this)),this.background=(t=>(this._background=t,this._container.style("background",t),this)),this.playhead=(t=>(this._playheadcolor=t,this._secondaryWaveform.style("border-right","1px solid "+this._playheadcolor),this)),this.barWidth=(t=>(this._barWidth=t,this)),this.barGap=(t=>(this._gap=t,this)),this.type=(t=>("bar"==t?(this._type="bar",this._gap=1):(this._type="waveform",this._gap=0),this)),this.meter=((t,e,i)=>{let s=d3.select(t);this._meter=s.append("canvas").attr("height",s.style("height")).attr("width",s.style("width")).attr("position","absolute");let a=this._meter.node().getContext("2d");const h=parseInt(this._meter.attr("width")),n=parseInt(this._meter.attr("height"));return a.fillStyle=i,a.rect(0,0,h,n),a.fill(),this._meterFill=e,this._meterEnabled=!0,this}),this.setSubliminal=(t=>{o(()=>{d(t)})}),this.getOutputNode=(()=>(null==this._output&&o(),this._output)),this.getContext=(()=>(null==this._ctx&&o(),this._ctx)),this.isPlaying=(()=>this._isPlaying),this.alt.isPlaying=(()=>this.alt._isPlaying),(t=>{this._container=d3.select(t).style("overflow-x","scroll").style("overflow-y","hidden"),this._analyserContainer=d3.select(document.createElement("div")),this._multiplier=1,this._width=this._container.node().offsetWidth,this._height=this._container.node().offsetHeight,this._background="white",this._color="rgb(153, 153, 153)",this._secondaryColor="black",this._playheadcolor="black",this._barWidth=1,this._gap=1,this._type="waveform",this._audioElement=d3.select(document.createElement("audio")),this._altAudioElement=d3.select(document.createElement("audio")),this._mainWaveform=d3.select(document.createElement("div")).style("height","100%").style("width","100%").style("position","absolute").style("overflow-x","hidden").style("overflow-y","hidden"),this._mainWaveform.on("click",function(){s(d3.mouse(this)[0])}),this._container.append(()=>this._mainWaveform.node()),this._secondaryWaveform=d3.select(document.createElement("div")).style("height","100%").style("width","0px").style("position","absolute").style("border-right","1px solid #111").style("z-index","3").style("overflow","hidden"),this._secondaryWaveform.on("click",function(){s(d3.mouse(this)[0])}),this._container.append(()=>this._secondaryWaveform.node()),this._container.append(()=>this._audioElement.node()),this._container.append(()=>this._altAudioElement.node())})(t),this}}class AudioRecorder{static create(t){return new AudioRecorder(t)}constructor(t){const e=()=>{this._ctx=new(window.AudioContext||window.webkitAudioContext),this._isPlaying=!1},i=(t,e,i=!1)=>{const s=Math.round(t.length/e);var a=[];const h=s;for(var n=0;n<e;n++){for(var r=0,l=0,o=0;o<h;o++){var d=t[n*s+o];d>0?r+=d:l+=d}i?(a.push(2*r/h),a.push(2*l/h)):a.push([l/h,r/h])}return a},s=t=>{let e="bar"==this._type?this._barWidth:1,i="bar"==this._type?this._gap:0,s=e+i,a=this._height,h=a*this._multiplier;((i,n)=>{let r=this._color,l=this._mainWaveform;let o=t.length*s;null==this._canvas?this._canvas=l.append("canvas").attr("width",o).attr("height",this._height).style("border-right","1px solid "+this._playheadcolor):this._canvas.attr("width",o),(t=>{null==this._context&&(this._context=t.node().getContext("2d")),null==this._dataContainer&&(this._dataContainer=document.createElement("custom"),this._dataCanvas=d3.select(document.createElement("canvas")),this._dataCanvas.attr("height",t.attr("height")));let n=d3.select(this._dataContainer).selectAll("custom.rect").data(i);const l=()=>this._context,o=()=>this._dataCanvas.node();n.enter().append("custom").classed("rect",!0).attr("x",(t,e)=>e*s).attr("y",function(t,e){return a/2-h*t[1]}).attr("width",e).attr("height",function(t){return h*(t[1]-t[0])}).attr("fillStyle",r).call(e=>{let i=l();return i.fillStyle=this._background,i.fillRect(0,0,i.canvas.width,i.canvas.height),e.each(function(t,e){let s=d3.select(this);i.drawImage(o(),0,0),i.beginPath(),i.fillStyle=s.attr("fillStyle"),i.rect(s.attr("x"),s.attr("y"),s.attr("width"),s.attr("height")),i.fill(),i.closePath()}),this._dataCanvas.attr("width",t.attr("width")),o().getContext("2d").drawImage(t.node(),0,0),e})})(this._canvas)})(t)},a=t=>{let e=t,i=Math.max.apply(null,e);return e.forEach((t,s)=>{0!=t&&(e[s]=t/i)}),e},h=()=>{let t=!0;return null!=this._mediaRecorder&&this._mediaRecorder.isRecording()&&(this._mainWaveform.style("overflow-x","scroll"),this._mediaRecorder.finishRecording(),this._stream.getTracks().forEach(t=>{t.stop()}),this._data=[],this._ctx.suspend(),this._dataCanvas.remove(),this._dataContainer=null,this._dataCanvas=null,t=!1),t},n=()=>{r(()=>{this._ctx.resume(),navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{this._recordingTime=0,this._currentTime=new Date,Tone.context=this._ctx,this._mainWaveform.style("overflow-x","hidden"),this._stream=t;const e=this._ctx.createMediaStreamSource(t);this.merger=this._ctx.createChannelMerger(2);let h=this._ctx.createAnalyser(),n=this._ctx.createGain(),r=new Tone.Tremolo(17e3,1),l=new Tone.Filter(16e3,"highpass",-48);r.spread=0,Tone.connect(e,n),Tone.connect(n,r),r.connect(l),l.connect(this.merger,0,1),e.connect(this.merger,0,0),e.connect(h),this._mediaRecorder=new WebAudioRecorder(this.merger,{workerDir:this._libraryPath,encoding:"wav"}),r.start(),this._mediaRecorder.startRecording(),h.fftSize=2048;let o=h.frequencyBinCount,d=new Float32Array(o);h.getFloatTimeDomainData(d),this._data=[];const c=()=>{if(this._drawVisual=requestAnimationFrame(c),h.getFloatTimeDomainData(d),this._mediaRecorder.isRecording()){let t=new Date;this._recordingTime=t-this._currentTime;let e=i(d,~~(d.length/1e3));for(let t of e)this._data.push(t);s(this._data)}_()},_=()=>{let t,e;if(this._mediaRecorder.isRecording()){let i=0;d.forEach((t,e)=>{i+=Math.sqrt(Math.abs(t))});let s=i/d.length;t=((e=s>this._lastMean?10*Math.log10(s):10*Math.log10(this._lastMean)-1)+30)/30,this._lastMean=s}else t=((e=10*Math.log10(this._lastMean)-1)+30)/30,this._lastMean=Math.pow(10,e/10),e<-60&&cancelAnimationFrame(this._drawVisual);let i=this._meter.node().getContext("2d");const s=parseInt(this._meter.attr("width")),a=parseInt(this._meter.attr("height"));i.fillStyle=this._background,i.fillRect(0,0,s,a),i.fillStyle=this._meterFill,i.fillRect(0,a*(1-t),s,a*t)};this._mediaRecorder.onComplete=((t,e)=>{e.arrayBuffer().then(t=>{this._ctx.decodeAudioData(t).then(t=>{this.getRecordingData(e,(t=>{let e=[];const s=i(a(t.getChannelData(0)),1920,!0),h=i(a(t.getChannelData(1)),1920,!0);return e.push(s),e.push(h),JSON.stringify(e)})(t))})})}),c()})})},r=t=>{this._ready||(e(),this._ready=!0),t()};return this.stop=(()=>{this._stopRecording}),this.record=(()=>{h()&&n()}),this.getRecordingData=(()=>{}),this.height=(t=>(this._multiplier=t,this)),this.fill=((t,e)=>(this._color=t,null!=e&&(this._secondaryColor=e),this)),this.background=(t=>(this._background=t,this._container.style("background",t),this)),this.playhead=(t=>(this._playheadcolor=t,this)),this.barWidth=(t=>(this._barWidth=t,this)),this.barGap=(t=>(this._gap=t,this)),this.type=(t=>("bar"==t?(this._type="bar",this._gap=1):(this._type="waveform",this._gap=0),this)),this.meter=((t,e,i)=>{let s=d3.select(t);this._meter=s.append("canvas").attr("height",s.style("height")).attr("width",s.style("width")).attr("position","absolute");let a=this._meter.node().getContext("2d");const h=parseInt(this._meter.attr("width")),n=parseInt(this._meter.attr("height"));return a.fillStyle=i,a.rect(0,0,h,n),a.fill(),this._meterFill=e,this._meterEnabled=!0,this}),this.libraryPath=(t=>(this._libraryPath=t,this)),this.getRecordingTime=(()=>(null==this._recordingTime&&(this._recordingTime=0),this._recordingTime)),(t=>{this._container=d3.select(t).style("overflow-x","scroll").style("overflow-y","hidden"),this._multiplier=1,this._width=this._container.node().offsetWidth,this._height=this._container.node().offsetHeight,this._background="white",this._color="rgb(153, 153, 153)",this._secondaryColor="black",this._playheadcolor="black",this._barWidth=1,this._gap=1,this._type="waveform",this._audioElement=d3.select(document.createElement("audio")),this._mainWaveform=d3.select(document.createElement("div")).style("height",this._height+"px").style("width",this._width+"px").style("position","absolute").style("overflow-x","hidden").style("overflow-y","hidden"),this._mainWaveform.style("direction","rtl"),this._container.append(()=>this._mainWaveform.node()),this._container.append(()=>this._audioElement.node())})(t),this}}
